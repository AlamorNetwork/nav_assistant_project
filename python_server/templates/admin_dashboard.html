<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>سبدگردان کاریزما - پنل مدیریت</title>
  <style>
    body { font-family: sans-serif; background:#eef2f1; margin:0; padding:24px; }
    .wrap { max-width: 1100px; margin: 0 auto; }
    .card { background:#fff; padding:16px; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,.06); margin-bottom:16px; border:1px solid #e6e8ea; }
    h2, h3 { margin: 8px 0 16px; color:#1f2937; border-bottom:2px solid #2A623D; padding-bottom:6px; }
    table { width:100%; border-collapse: collapse; }
    th, td { border-bottom:1px solid #eee; padding:8px; text-align:right; }
    input, select, textarea, button { padding:10px 12px; border-radius:8px; border:1px solid #d1d5db; margin:6px 0; font-family: inherit; }
    button { background:#2A623D; color:#fff; border:none; cursor:pointer; }
    button:hover { background:#1A472A; }
    .row { display:flex; gap:12px; align-items:center; flex-wrap: wrap; }
    .col { flex:1; min-width: 200px; }
    .muted { color:#6b7280; }
    .grid { display:grid; grid-template-columns: 1fr 1fr; gap:16px; }
    .grid-3 { display:grid; grid-template-columns: 1fr 1fr 1fr; gap:16px; }
    .two-col { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h2>کاربران</h2>
      <form action="/admin/create-user" method="post" class="row">
        <input class="col" type="text" name="username" placeholder="نام کاربری" required>
        <input class="col" type="password" name="password" placeholder="رمز" required>
        <select class="col" name="role">
          <option value="user">کاربر</option>
          <option value="admin">ادمین</option>
        </select>
        <button type="submit">افزودن</button>
      </form>
      <table>
        <thead><tr><th>نام کاربری</th><th>نقش</th><th>تاریخ ایجاد</th></tr></thead>
        <tbody>
          {% for u in users %}
          <tr>
            <td>{{ u['username'] }}</td>
            <td>{{ u['role'] }}</td>
            <td class="muted">{{ u['created_at'] }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="card">
      <h2>صندوق‌ها</h2>
      <form action="/admin/create-fund" method="post" class="row">
        <input class="col" type="text" name="name" placeholder="نام صندوق" required>
        <input class="col" type="text" name="api_symbol" placeholder="شناسه API" required>
        <select class="col" name="type">
          <option value="rayan">رایان هم‌افزار</option>
          <option value="tadbir">تدبیر رایان پرداز</option>
        </select>
        <button type="submit">افزودن</button>
      </form>
      <table>
        <thead><tr><th>نام</th><th>نوع</th><th>شناسه</th></tr></thead>
        <tbody>
          {% for f in funds %}
          <tr>
            <td>{{ f['name'] }}</td>
            <td>{{ f['type'] }}</td>
            <td class="muted">{{ f['api_symbol'] }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="card">
      <h2>تمپلیت‌ها (سلکتورها)</h2>
      <div class="grid">
        <form action="/admin/update-template" method="post">
          <h3>ثبت/ویرایش تمپلیت با JSON</h3>
          <div class="row">
            <input class="col" type="text" name="template_name" placeholder="نام تمپلیت (مثلاً rayan یا tadbir)" required>
          </div>
          <div class="row">
            <textarea name="template_data" rows="12" style="width:100%;" placeholder='{"tolerance":4, "nav_page_url":"...", "date_selector":"#navDate", ...}' required>{{ tpl_json }}</textarea>
          </div>
          <button type="submit">ذخیره تمپلیت</button>
        </form>

        <form action="/admin/apply-template" method="post">
          <h3>اعمال تمپلیت به صندوق</h3>
          <div class="row">
            <input class="col" type="text" name="fund_name" placeholder="نام صندوق (دقیق)" required>
            <select class="col" name="template_name" required>
              {% for t in templates %}
              <option value="{{ t['name'] }}">{{ t['name'] }} (tol: {{ t['tolerance'] }})</option>
              {% endfor %}
            </select>
          </div>
          <button type="submit">اعمال</button>
        </form>
      </div>
    </div>

    <div class="card">
      <h3>ویرایش تمپلیت به سبک فرم (Field-wise)</h3>
      <form class="two-col" action="/admin/upsert-template-fields" method="post">
        <input type="text" name="name" placeholder="نام تمپلیت" value="{{ tpl and tpl['name'] or '' }}" required>
        <input type="number" step="0.01" name="tolerance" placeholder="tolerance" value="{{ tpl and tpl['tolerance'] or '' }}">
        <input type="text" name="nav_page_url" placeholder="nav_page_url" value="{{ tpl and tpl['nav_page_url'] or '' }}">
        <input type="text" name="expert_price_page_url" placeholder="expert_price_page_url" value="{{ tpl and tpl['expert_price_page_url'] or '' }}">
        <input type="text" name="date_selector" placeholder="date_selector" value="{{ tpl and tpl['date_selector'] or '' }}">
        <input type="text" name="time_selector" placeholder="time_selector" value="{{ tpl and tpl['time_selector'] or '' }}">
        <input type="text" name="nav_price_selector" placeholder="nav_price_selector" value="{{ tpl and tpl['nav_price_selector'] or '' }}">
        <input type="text" name="total_units_selector" placeholder="total_units_selector" value="{{ tpl and tpl['total_units_selector'] or '' }}">
        <input type="text" name="nav_search_button_selector" placeholder="nav_search_button_selector" value="{{ tpl and tpl['nav_search_button_selector'] or '' }}">
        <input type="text" name="securities_list_selector" placeholder="securities_list_selector" value="{{ tpl and tpl['securities_list_selector'] or '' }}">
        <input type="text" name="sellable_quantity_selector" placeholder="sellable_quantity_selector" value="{{ tpl and tpl['sellable_quantity_selector'] or '' }}">
        <input type="text" name="expert_price_selector" placeholder="expert_price_selector" value="{{ tpl and tpl['expert_price_selector'] or '' }}">
        <input type="text" name="increase_rows_selector" placeholder="increase_rows_selector" value="{{ tpl and tpl['increase_rows_selector'] or '' }}">
        <input type="text" name="expert_search_button_selector" placeholder="expert_search_button_selector" value="{{ tpl and tpl['expert_search_button_selector'] or '' }}">
        <button type="submit">ذخیره</button>
      </form>
    </div>
  </div>
</body>
</html>

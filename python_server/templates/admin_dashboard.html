<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>سبدگردان کاریزما - پنل مدیریت</title>
  <style>
    body { font-family: sans-serif; background:#eef2f1; margin:0; padding:24px; }
    .wrap { max-width: 1100px; margin: 0 auto; }
    .card { background:#fff; padding:16px; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,.06); margin-bottom:16px; border:1px solid #e6e8ea; }
    h2, h3 { margin: 8px 0 16px; color:#1f2937; border-bottom:2px solid #2A623D; padding-bottom:6px; }
    table { width:100%; border-collapse: collapse; }
    th, td { border-bottom:1px solid #eee; padding:8px; text-align:right; }
    input, select, textarea, button { padding:10px 12px; border-radius:8px; border:1px solid #d1d5db; margin:6px 0; font-family: inherit; }
    button { background:#2A623D; color:#fff; border:none; cursor:pointer; }
    button:hover { background:#1A472A; }
    .row { display:flex; gap:12px; align-items:center; flex-wrap: wrap; }
    .col { flex:1; min-width: 200px; }
    .muted { color:#6b7280; }
    .grid { display:grid; grid-template-columns: 1fr 1fr; gap:16px; }
    .grid-3 { display:grid; grid-template-columns: 1fr 1fr 1fr; gap:16px; }
    .two-col { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
  </style>
</head>
<body>
  <div class="wrap">
    {% if message %}
    <div class="card" style="border-left:6px solid #2A623D;">
      <div class="row"><div class="col">{{ message }}</div></div>
    </div>
    {% endif %}
    <div class="card">
      <h2>کاربران</h2>
      <form action="/admin/create-user" method="post" class="row">
        <input class="col" type="text" name="username" placeholder="نام کاربری" required>
        <input class="col" type="password" name="password" placeholder="رمز" required>
        <select class="col" name="role">
          <option value="user">کاربر</option>
          <option value="admin">ادمین</option>
        </select>
        <button type="submit">افزودن</button>
      </form>
      <table>
        <thead><tr><th>نام کاربری</th><th>نقش</th><th>تاریخ ایجاد</th></tr></thead>
        <tbody>
          {% for u in users %}
          <tr>
            <td>{{ u['username'] }}</td>
            <td>{{ u['role'] }}</td>
            <td class="muted">{{ u['created_at'] }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="card">
      <h2>صندوق‌ها</h2>
      <form action="/admin/create-fund" method="post" class="row">
        <input class="col" type="text" name="name" placeholder="نام صندوق" required>
        <input class="col" type="text" name="api_symbol" placeholder="شناسه API" required>
        <input class="col" type="url" name="nav_page_url" placeholder="nav_page_url (URL وضعیت ارزش صندوق)" required>
        <input class="col" type="url" name="expert_price_page_url" placeholder="expert_price_page_url (URL قیمت کارشناسی)" required>
        <select class="col" name="type">
          <option value="rayan">رایان هم‌افزار</option>
          <option value="tadbir">تدبیر رایان پرداز</option>
        </select>
        <button type="submit">افزودن</button>
      </form>
      <table>
        <thead><tr><th>نام</th><th>نوع</th><th>شناسه</th><th>عملیات</th></tr></thead>
        <tbody>
          {% for f in funds %}
          <tr>
            <td>{{ f['name'] }}</td>
            <td>{{ f['type'] }}</td>
            <td class="muted">{{ f['api_symbol'] }}</td>
            <td>
              <button onclick="editFund({{ f['id'] }}, '{{ f['name'] }}', '{{ f['api_symbol'] }}', '{{ f['nav_page_url'] }}', '{{ f['expert_price_page_url'] }}', '{{ f['type'] }}')" style="background: #007bff; color: white; border: none; padding: 5px 10px; margin: 2px; border-radius: 3px; cursor: pointer;">ویرایش</button>
              <button onclick="deleteFund({{ f['id'] }}, '{{ f['name'] }}')" style="background: #dc3545; color: white; border: none; padding: 5px 10px; margin: 2px; border-radius: 3px; cursor: pointer;">حذف</button>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="card">
      <h2>تمپلیت‌ها (سلکتورها)</h2>
      <div class="grid">
        <form action="/admin/update-template" method="post">
          <h3>ثبت/ویرایش تمپلیت با JSON</h3>
          <div class="row">
            <input class="col" type="text" name="template_name" placeholder="نام تمپلیت (مثلاً rayan یا tadbir)" required>
          </div>
          <div class="row">
            <textarea name="template_data" rows="12" style="width:100%;" placeholder='{"tolerance":4, "nav_page_url":"...", "date_selector":"#navDate", ...}' required>{{ tpl_json }}</textarea>
          </div>
          <button type="submit">ذخیره تمپلیت</button>
        </form>

        <form action="/admin/apply-template" method="post">
          <h3>اعمال تمپلیت به صندوق</h3>
          <div class="row">
            <select class="col" name="fund_name" required>
              {% for f in funds %}
              <option value="{{ f['name'] }}">{{ f['name'] }} ({{ f['type'] }})</option>
              {% endfor %}
            </select>
            <select class="col" name="template_name" required>
              {% for t in templates %}
              <option value="{{ t['name'] }}">{{ t['name'] }} (tol: {{ t['tolerance'] }})</option>
              {% endfor %}
            </select>
          </div>
          <button type="submit">اعمال</button>
        </form>
      </div>
      
      <!-- Templates Table -->
      <h3>تمپلیت‌های موجود</h3>
      <table>
        <thead>
          <tr>
            <th>نام</th>
            <th>تلورانس</th>
            <th>عملیات</th>
          </tr>
        </thead>
        <tbody>
          {% for t in templates %}
          <tr>
            <td>{{ t['name'] }}</td>
            <td>{{ t['tolerance'] }}%</td>
            <td>
              <button onclick="editTemplate('{{ t['name'] }}')" style="background: #007bff; color: white; border: none; padding: 5px 10px; margin: 2px; border-radius: 3px; cursor: pointer;">ویرایش</button>
              <button onclick="deleteTemplate('{{ t['name'] }}')" style="background: #dc3545; color: white; border: none; padding: 5px 10px; margin: 2px; border-radius: 3px; cursor: pointer;">حذف</button>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="card">
      <h2>اساین صندوق به کاربر</h2>
      <form action="/admin/assign-fund" method="post" class="row">
        <select class="col" name="username" required>
          {% for u in users %}
          <option value="{{ u['username'] }}">{{ u['username'] }}</option>
          {% endfor %}
        </select>
        <select class="col" name="fund_name" required>
          {% for f in funds %}
          <option value="{{ f['name'] }}">{{ f['name'] }}</option>
          {% endfor %}
        </select>
        <button type="submit">اساین</button>
      </form>
      <form action="/admin/unassign-fund" method="post" class="row">
        <select class="col" name="username" required>
          {% for u in users %}
          <option value="{{ u['username'] }}">{{ u['username'] }}</option>
          {% endfor %}
        </select>
        <select class="col" name="fund_name" required>
          {% for f in funds %}
          <option value="{{ f['name'] }}">{{ f['name'] }}</option>
          {% endfor %}
        </select>
        <button type="submit">حذف اساین</button>
      </form>
      <table>
        <thead><tr><th>کاربر</th><th>صندوق</th></tr></thead>
        <tbody>
          {% for uf in user_funds %}
          <tr>
            <td>{{ uf['username'] }}</td>
            <td>{{ uf['fund_name'] }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- Edit Fund Modal -->
  <div id="editModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
    <div style="position: relative; top: 10%; margin: auto; background: white; padding: 20px; width: 80%; max-width: 600px; border-radius: 8px;">
      <h3>ویرایش صندوق</h3>
      <form id="editForm" action="/admin/edit-fund" method="post">
        <input type="hidden" id="editFundId" name="fund_id">
        <div class="row">
          <input class="col" type="text" id="editName" name="name" placeholder="نام صندوق" required>
          <input class="col" type="text" id="editApiSymbol" name="api_symbol" placeholder="شناسه API" required>
        </div>
        <div class="row">
          <input class="col" type="url" id="editNavUrl" name="nav_page_url" placeholder="nav_page_url" required>
        </div>
        <div class="row">
          <input class="col" type="url" id="editExpertUrl" name="expert_price_page_url" placeholder="expert_price_page_url" required>
        </div>
        <div class="row">
          <select class="col" id="editType" name="type">
            <option value="rayan">رایان هم‌افزار</option>
            <option value="tadbir">تدبیر رایان پرداز</option>
          </select>
        </div>
        <div class="row" style="margin-top: 20px;">
          <button type="submit" style="background: #28a745; color: white; border: none; padding: 10px 20px; margin: 5px; border-radius: 4px; cursor: pointer;">ذخیره تغییرات</button>
          <button type="button" onclick="closeEditModal()" style="background: #6c757d; color: white; border: none; padding: 10px 20px; margin: 5px; border-radius: 4px; cursor: pointer;">انصراف</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Delete Fund Modal -->
  <div id="deleteModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
    <div style="position: relative; top: 20%; margin: auto; background: white; padding: 20px; width: 400px; border-radius: 8px; text-align: center;">
      <h3>تأیید حذف</h3>
      <p>آیا مطمئن هستید که می‌خواهید صندوق "<span id="deleteFundName"></span>" را حذف کنید؟</p>
      <p style="color: #dc3545; font-size: 14px;">⚠️ این عمل غیرقابل بازگشت است و تمام کانفیگوریشن‌ها و تخصیص‌های مربوط به این صندوق حذف خواهد شد.</p>
      <form id="deleteForm" action="/admin/delete-fund" method="post" style="margin-top: 20px;">
        <input type="hidden" id="deleteFundId" name="fund_id">
        <button type="submit" style="background: #dc3545; color: white; border: none; padding: 10px 20px; margin: 5px; border-radius: 4px; cursor: pointer;">بله، حذف کن</button>
        <button type="button" onclick="closeDeleteModal()" style="background: #6c757d; color: white; border: none; padding: 10px 20px; margin: 5px; border-radius: 4px; cursor: pointer;">انصراف</button>
      </form>
    </div>
  </div>

  <!-- Edit Template Modal -->
  <div id="editTemplateModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
    <div style="position: relative; top: 5%; margin: auto; background: white; padding: 20px; width: 90%; max-width: 800px; border-radius: 8px; max-height: 90%; overflow-y: auto;">
      <h3>ویرایش تمپلیت</h3>
      <form id="editTemplateForm" action="/admin/edit-template" method="post">
        <input type="hidden" id="editTemplateName" name="template_name">
        <div class="row">
          <label style="font-weight: bold; margin-bottom: 10px;">نام تمپلیت: <span id="templateNameDisplay"></span></label>
        </div>
        <div class="row">
          <textarea id="editTemplateData" name="template_data" rows="20" style="width:100%; font-family: monospace; font-size: 12px;" placeholder='{"tolerance": 4.0, "nav_page_url": "...", ...}' required></textarea>
        </div>
        <div class="row" style="margin-top: 20px;">
          <button type="submit" style="background: #28a745; color: white; border: none; padding: 10px 20px; margin: 5px; border-radius: 4px; cursor: pointer;">ذخیره تغییرات</button>
          <button type="button" onclick="closeEditTemplateModal()" style="background: #6c757d; color: white; border: none; padding: 10px 20px; margin: 5px; border-radius: 4px; cursor: pointer;">انصراف</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Delete Template Modal -->
  <div id="deleteTemplateModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
    <div style="position: relative; top: 20%; margin: auto; background: white; padding: 20px; width: 400px; border-radius: 8px; text-align: center;">
      <h3>تأیید حذف تمپلیت</h3>
      <p>آیا مطمئن هستید که می‌خواهید تمپلیت "<span id="deleteTemplateName"></span>" را حذف کنید؟</p>
      <p style="color: #dc3545; font-size: 14px;">⚠️ این عمل غیرقابل بازگشت است.</p>
      <form id="deleteTemplateForm" action="/admin/delete-template" method="post" style="margin-top: 20px;">
        <input type="hidden" id="deleteTemplateNameInput" name="template_name">
        <button type="submit" style="background: #dc3545; color: white; border: none; padding: 10px 20px; margin: 5px; border-radius: 4px; cursor: pointer;">بله، حذف کن</button>
        <button type="button" onclick="closeDeleteTemplateModal()" style="background: #6c757d; color: white; border: none; padding: 10px 20px; margin: 5px; border-radius: 4px; cursor: pointer;">انصراف</button>
      </form>
    </div>
  </div>

  <script>
    function editFund(id, name, apiSymbol, navUrl, expertUrl, type) {
      document.getElementById('editFundId').value = id;
      document.getElementById('editName').value = name;
      document.getElementById('editApiSymbol').value = apiSymbol;
      document.getElementById('editNavUrl').value = navUrl;
      document.getElementById('editExpertUrl').value = expertUrl;
      document.getElementById('editType').value = type;
      document.getElementById('editModal').style.display = 'block';
    }

    function closeEditModal() {
      document.getElementById('editModal').style.display = 'none';
    }

    function deleteFund(id, name) {
      document.getElementById('deleteFundId').value = id;
      document.getElementById('deleteFundName').textContent = name;
      document.getElementById('deleteModal').style.display = 'block';
    }

    function closeDeleteModal() {
      document.getElementById('deleteModal').style.display = 'none';
    }

    // Template functions
    async function editTemplate(templateName) {
      try {
        // Fetch template data
        const response = await fetch(`/admin/template/${templateName}`);
        if (!response.ok) {
          // If endpoint doesn't exist, create a default template structure
          const defaultTemplate = {
            tolerance: 4.0,
            nav_page_url: "",
            expert_price_page_url: "",
            date_selector: "",
            time_selector: "",
            nav_price_selector: "",
            total_units_selector: "",
            nav_search_button_selector: "",
            securities_list_selector: "",
            sellable_quantity_selector: "",
            expert_price_selector: "",
            increase_rows_selector: "",
            expert_search_button_selector: ""
          };
          
          document.getElementById('editTemplateName').value = templateName;
          document.getElementById('templateNameDisplay').textContent = templateName;
          document.getElementById('editTemplateData').value = JSON.stringify(defaultTemplate, null, 2);
        } else {
          const templateData = await response.json();
          document.getElementById('editTemplateName').value = templateName;
          document.getElementById('templateNameDisplay').textContent = templateName;
          document.getElementById('editTemplateData').value = JSON.stringify(templateData, null, 2);
        }
        
        document.getElementById('editTemplateModal').style.display = 'block';
      } catch (error) {
        console.error('Error loading template:', error);
        alert('خطا در بارگذاری تمپلیت');
      }
    }

    function closeEditTemplateModal() {
      document.getElementById('editTemplateModal').style.display = 'none';
    }

    function deleteTemplate(templateName) {
      document.getElementById('deleteTemplateNameInput').value = templateName;
      document.getElementById('deleteTemplateName').textContent = templateName;
      document.getElementById('deleteTemplateModal').style.display = 'block';
    }

    function closeDeleteTemplateModal() {
      document.getElementById('deleteTemplateModal').style.display = 'none';
    }

    // Close modals when clicking outside
    window.onclick = function(event) {
      const editModal = document.getElementById('editModal');
      const deleteModal = document.getElementById('deleteModal');
      const editTemplateModal = document.getElementById('editTemplateModal');
      const deleteTemplateModal = document.getElementById('deleteTemplateModal');
      
      if (event.target === editModal) {
        closeEditModal();
      }
      if (event.target === deleteModal) {
        closeDeleteModal();
      }
      if (event.target === editTemplateModal) {
        closeEditTemplateModal();
      }
      if (event.target === deleteTemplateModal) {
        closeDeleteTemplateModal();
      }
    }
  </script>
</body>
</html>
